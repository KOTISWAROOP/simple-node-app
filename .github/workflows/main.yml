name: Node.js CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  #--------------------------------
  # 1. BUILD STAGE
  #--------------------------------
  build:
    runs-on: ubuntu-latest
    name: "Stage 1: Build & Lint"
    
    steps:
    - name: "Checkout code"
      uses: actions/checkout@v4

    - name: "Set up Node.js"
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm' # Cache npm dependencies for faster builds

    - name: "Install dependencies"
      run: npm ci # Use 'ci' for cleaner, more reliable installs in CI

    - name: "Lint code (if linter is configured)"
      run: npm run lint --if-present

  #--------------------------------
  # 2. TEST STAGE
  #--------------------------------
  test:
    runs-on: ubuntu-latest
    name: "Stage 2: Run Unit Tests"
    needs: build # This stage only runs if the 'build' stage succeeds
    
    steps:
    - name: "Checkout code"
      uses: actions/checkout@v4

    - name: "Set up Node.js"
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'

    - name: "Install dependencies"
      run: npm ci

    - name: "Run tests and generate coverage report"
      run: npm test -- --coverage # Assumes Jest is configured for coverage

    - name: "Upload test coverage report"
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: coverage/ # Path where Jest coverage report is generated

  #--------------------------------
  # 3. PACKAGE STAGE
  #--------------------------------
  package:
    runs-on: ubuntu-latest
    name: "Stage 3: Package Application for Deployment"
    needs: test # This stage only runs if 'test' succeeds

    steps:
    - name: "Checkout code"
      uses: actions/checkout@v4

    - name: "Set up Node.js"
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'

    - name: "Install production dependencies"
      run: npm ci --omit=dev # Install only production dependencies for a smaller package

    - name: "Create deployment package"
      run: |
        mkdir -p deploy-package
        cp app.js deploy-package/
        cp package.json deploy-package/
        cp package-lock.json deploy-package/
        cp -r node_modules/ deploy-package/node_modules/

    - name: "Upload deployment artifact"
      uses: actions/upload-artifact@v4
      with:
        name: node-app-package
        path: deploy-package/

  #--------------------------------
  # 4. DEPLOY STAGE
  #--------------------------------
  deploy:
    runs-on: ubuntu-latest
    name: "Stage 4: Deploy to Production"
    needs: package # This stage only runs if 'package' succeeds
    environment: 'production' # Defines a GitHub environment for protection rules

    steps:
    - name: "Download deployment package"
      uses: actions/download-artifact@v4
      with:
        name: node-app-package

    - name: "Simulate deployment"
      run: |
        echo "Deploying application..."
        ls -R
        echo "Deployment complete."
        # In a real scenario, this is where you would have scripts
        # to SSH, SCP, or use a cloud provider's CLI to deploy the files.